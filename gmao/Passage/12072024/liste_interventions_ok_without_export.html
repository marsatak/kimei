{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des interventions{% endblock title %}

{% block nav-btn %}
    <a href="{% url 'logout' %}" id="btn-nav"
       class="btn btn-outline-danger text-center text-light border-light btn-sm mx-2">Logout</a>
    <a href="{% url 'gmao:home' %}" id="btn-nav"
       class="btn btn-outline-primary text-center text-light border-light btn-sm mx-2">Retour à l'accueil</a>
{% endblock nav-btn %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
          href="https://cdn.datatables.net/buttons/1.7.0/css/buttons.dataTables.min.css">
{% endblock %}

{% block navbar-content %}
    {{ user.first_name }} {{ user.last_name }}
{% endblock navbar-content %}

{% block content %}
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Liste des interventions</h4>
                        <div class="filter-container">
                            <button class="btn btn-light btn-sm">Filtrer</button>
                            <button class="btn btn-light btn-sm">Réinitialiser</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <table id="tableInterventions" class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <th>NDI</th>
                                <th>Station</th>
                                <th>Panne</th>
                                <th>FI</th>
                                <th>Début travail</th>
                                <th>Fin travail</th>
                                <th>Statut</th>
                                <th>Techniciens</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Les données seront insérées ici par DataTables -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.7.0/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <script>
        $(document).ready(function () {
            var table = $('#tableInterventions').DataTable({
                // Supposons que vous chargez les données via AJAX
                ajax: '{% url "gmao:api_interventions" %}',
                columns: [
                    {data: 'ndi'},
                    {data: 'station'},
                    {data: 'panne'},
                    {data: 'fi'},
                    {data: 'debut_travail'},
                    {data: 'fin_travail'},
                    {data: 'statut'},
                    {data: 'techniciens'},
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<button class="btn btn-sm btn-primary">Éditer</button>';
                        }
                    }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        text: 'Exporter en Excel',
                        action: function (e, dt, node, config) {
                            exportToExcel(dt);
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/French.json'
                }
            });

            function exportToExcel(dt) {
                const data = dt.data().toArray();
                const formattedData = data.map(function (row) {
                    return {
                        'NDI': row.ndi,
                        'Station': row.station,
                        'Panne': row.panne,
                        'FI': row.fi,
                        'Début travail': row.debut_travail,
                        'Fin travail': row.fin_travail,
                        'Statut': row.statut,
                        'Techniciens': row.techniciens
                    };
                });

                const ws = XLSX.utils.json_to_sheet(formattedData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Interventions");

                const wbout = XLSX.write(wb, {bookType: 'xlsx', type: 'binary'});

                function s2ab(s) {
                    const buf = new ArrayBuffer(s.length);
                    const view = new Uint8Array(buf);
                    for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                    return buf;
                }

                saveAs(new Blob([s2ab(wbout)], {type: "application/octet-stream"}), "liste_interventions.xlsx");
            }
        });
    </script>
{% endblock extra_js %}