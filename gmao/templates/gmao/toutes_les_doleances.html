{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Toutes les Doléances{% endblock title %}

{% block nav-btn %}
    <a href="{% url 'logout' %}" id="btn-nav"
       class="btn btn-outline-danger text-center text-light border-light btn-sm mx-2">Logout</a>
    <a href="{% url 'gmao:liste_interventions' %}" id="btn-nav"
       class="btn btn-outline-info text-center text-light border-light btn-sm mx-2">Liste des interventions</a>
    <a href="{% url 'gmao:home' %}" id="btn-nav"
       class="btn btn-outline-info text-center text-light border-light btn-sm mx-2">Accueil</a>
{% endblock nav-btn %}

{% block navbar-content %}
    {{ user.first_name }} {{ user.last_name }}
{% endblock navbar-content %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/jquery.dataTables.css">
{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Toutes les Doléances</h5>
                </div>
                <div class="card-body">
                    <div class="filter-container mb-3">
                        <div class="row g-2">
                            <div class="col-md-2">
                                <label for="yearFilter"></label><select id="yearFilter" class="form-select">
                                <option value="all">Toutes les années</option>
                                {% for year in years %}
                                    <option value="{{ year }}"
                                            {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="col-md-2">
                                <label for="monthFilter"></label><select id="monthFilter" class="form-select">
                                <option value="all">Tous les mois</option>
                                {% for month in months %}
                                    <option value="{{ month.0 }}"
                                            {% if month.0 == current_month %}selected{% endif %}>{{ month.1 }}</option>
                                {% endfor %}
                            </select>
                            </div>
                            <div class="col-md-3">
                                <label for="clientFilter"></label><select id="clientFilter" class="form-select">
                                <option value="">Tous les clients</option>
                            </select>
                            </div>
                        </div>
                    </div>
                    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Chargement...</span>
                        </div>
                        <p>Chargement des données en cours...</p>
                    </div>
                    <div class="table-container">
                        <table id="doleancesTable" class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <th>NDI</th>
                                <th>Date de transmission</th>
                                <th>Statut</th>
                                <th>Station</th>
                                <th>Élément</th>
                                <th>Panne déclarée</th>
                                <th>Date limite</th>
                                <th>Commentaire</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    {{ block.super }}
    <script type="text/javascript" charset="utf8"
            src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
    <script>
        $(document).ready(function () {
            const table = $('#doleancesTable').DataTable({
                "ajax": {
                    "url": "{% url 'gmao:get_doleances_data' %}",
                    "data": function (d) {
                        d.year = $('#yearFilter').val();
                        d.month = $('#monthFilter').val();
                        d.client = $('#clientFilter').val();
                    }
                },
                "columns": [
                    {"data": "ndi"},
                    {"data": "date_transmission"},
                    {"data": "statut"},
                    {"data": "station"},
                    {"data": "element"},
                    {"data": "panne_declarer"},
                    {"data": "date_deadline"},
                    {"data": "commentaire"},
                    {"data": "actions"}
                ],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.25/i18n/French.json"
                },
                "initComplete": function (settings, json) {
                    $('#yearFilter, #monthFilter').trigger('change');
                }
            });

            $('#yearFilter, #monthFilter, #clientFilter').change(function () {
                table.ajax.reload();
            });

            $.ajax({
                url: "{% url 'gmao:get_clients' %}",
                type: 'GET',
                success: function (response) {
                    const select = $('#clientFilter');
                    $.each(response.clients, function (index, client) {
                        select.append($('<option></option>').val(client.id).text(client.nom_client));
                    });
                }
            });
        });
    </script>
{% endblock extra_js %}