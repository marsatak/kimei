{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Toutes les Doléances{% endblock title %}

{% block nav-btn %}
    <a href="{% url 'logout' %}" class="btn btn-outline-danger text-center text-light border-light btn-sm mx-2"
       id="btn-nav">
        Logout
    </a>
    <a href="{% url 'gmao:liste_interventions' %}"
       class="btn btn-outline-info text-center text-light border-light btn-sm mx-2" id="btn-nav">
        Liste des interventions
    </a>
    <a href="{% url 'gmao:home' %}" class="btn btn-outline-info text-center text-light border-light btn-sm mx-2"
       id="btn-nav">
        Accueil
    </a>
{% endblock nav-btn %}

{% block navbar-content %}
    <i style="color: hsl(137, 90%, 50%);" class="fa-solid fa-user-alt"></i>
    &nbsp;&nbsp;&nbsp;{{ user.first_name }}&nbsp;{{ user.last_name }}
{% endblock navbar-content %}
{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css"
          integrity="sha512-MQXduO8IQnJVq1qmySpN87QQkiR1bZHtorbJBD0tzy7/0U9+YIC93QWHeGTEoojMVHWWNkoCp8V6OzVSYrX0oQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <style>
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .filter-container > * {
            margin-bottom: 0;
        }

        .form-select, .form-control {
            width: auto;
        }

        @media (max-width: 768px) {
            .filter-container {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-container > * {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
{% endblock %}
{% block content %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Toutes les Doléances</h5>
                    <div class="filter-container">
                        <label for="yearSelect">Année:</label>
                        <select id="yearSelect" class="form-select form-select-sm">
                            {% for year in years %}
                                <option value="{{ year }}"
                                        {% if year == current_year %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                        <label for="monthSelect">Mois:</label>
                        <select id="monthSelect" class="form-select form-select-sm">
                            {% for month in months %}
                                <option value="{{ month.0 }}"
                                        {% if month.0 == current_month %}selected{% endif %}>{{ month.1 }}</option>
                            {% endfor %}
                        </select>
                        <button id="showAllYear" class="btn btn-secondary btn-sm">Toute l'année</button>
                        <input type="text" id="startDate" class="form-control form-control-sm flatpickr-input"
                               placeholder="Date début">
                        <input type="text" id="endDate" class="form-control form-control-sm flatpickr-input"
                               placeholder="Date fin">
                        {% comment %}<input type="date" id="startDate" class="form-control form-control-sm">
                        <input type="date" id="endDate" class="form-control form-control-sm">{% endcomment %}
                        <button id="exportDateRange" class="btn btn-info btn-sm">Exporter plage</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" style="display: none; text-align: center; padding: 20px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Chargement...</span>
                        </div>
                        <p>Chargement des données en cours...</p>
                    </div>
                    <div class="table-container">
                        <table id="toutesDoléances" class="table table-striped table-bordered" style="width:100%">
                            <thead>
                            <tr>
                                <th></th>
                                <th>NDI</th>
                                <th>Date de transmission</th>
                                <th>Statut</th>
                                <th>Station</th>
                                <th>Élément</th>
                                <th>Panne déclarée</th>
                                <th>Date limite</th>
                                <th>Commentaire</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Les données seront remplies dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    {{ block.super }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"
            integrity="sha512-K/oyQtMXpxI4+K0W7H25UopjM8pzq0yrVdFdG21Fh5dBe91I40pDd9A4lzNlHPHBIP2cwZuoxaUSX0GJSObvGA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    {#    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>#}
    <script>
        $(document).ready(function () {
            let doleanceTable;
            const flatpickrConfig = {
                dateFormat: "Y-m-d",
                maxDate: "today",
                theme: "dark"
            };


            const startDatePicker = flatpickr("#startDate", {
                ...flatpickrConfig,
                onChange: function (selectedDates, dateStr, instance) {
                    endDatePicker.set('minDate', dateStr);
                }
            });

            const endDatePicker = flatpickr("#endDate", {
                ...flatpickrConfig,
                onChange: function (selectedDates, dateStr, instance) {
                    startDatePicker.set('maxDate', dateStr);
                }
            });

            {% comment %} flatpickr("#startDate", flatpickrConfig);
             flatpickr("#endDate", flatpickrConfig);{% endcomment %}

            function initializeTable(year, month) {
                if ($.fn.DataTable.isDataTable('#toutesDoléances')) {
                    $('#toutesDoléances').DataTable().destroy();
                }

                $('#loadingIndicator').show();
                $('#toutesDoléances').hide();

                doleanceTable = $('#toutesDoléances').DataTable({
                    ajax: {
                        url: '{% url "gmao:get_doleances_data" %}',
                        data: function (d) {
                            d.year = year;
                            d.month = month;
                            d.startDate = $('#startDate').val();
                            d.endDate = $('#endDate').val();
                        },
                        dataSrc: function (json) {
                            $('#loadingIndicator').hide();
                            $('#toutesDoléances').show();
                            return json.data;
                        }
                    },
                    columns: [
                        {
                            className: 'details-control',
                            orderable: false,
                            data: null,
                            defaultContent: '<button class="btn btn-sm btn-info">+</button>'
                        },
                        {data: "ndi"},
                        {data: "date_transmission"},
                        {data: "statut"},
                        {data: "station"},
                        {data: 'element'},
                        {data: 'panne_declarer'},
                        {data: 'date_deadline'},
                        {data: 'commentaire'},
                        {
                            data: null,
                            render: function (data, type, row) {
                                let buttons = '';
                                if (row.statut === 'NEW' || row.statut === 'ATD' || row.statut === 'ATP') {
                                    buttons += '<button class="btn btn-primary btn-sm declencher-intervention" data-id="' + row.id + '">Déclencher intervention</button> ';
                                }
                                return buttons;
                            }
                        }
                    ],
                    responsive: true,
                    autoWidth: false,
                    pageLength: 10,
                    language: {
                        url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/French.json'
                    },
                    dom: 'Bfrtip',
                    buttons: [
                        {
                            extend: 'excel',
                            text: 'Exporter en Excel',
                            exportOptions: {
                                columns: ':visible'
                            }
                        },
                    ],
                    ordering: false,
                    columnDefs: [
                        {
                            targets: '_all',
                            className: 'dt-head-nowrap',
                            render: function (data, type, row) {
                                if (type === 'display' && data != null && data.length > 70) {
                                    return `<span title="${data}">${data.substr(0, 70)}...</span>`;
                                }
                                return data;
                            }
                        },
                        {responsivePriority: 1, targets: 1}, // NDI
                        {responsivePriority: 2, targets: 3}, // Statut
                        {responsivePriority: 3, targets: 6}, // Panne déclarée
                        {responsivePriority: 10000, targets: [2, 4, 5, 7, 8, 9]}
                    ],
                    createdRow: function (row, data, dataIndex) {
                        if (data.statut === 'NEW') {
                            $(row).addClass('table-success');
                        } else if (data.statut === 'ATP') {
                            $(row).addClass('table-warning');
                        } else if (data.statut === 'ATD') {
                            $(row).addClass('table-danger');
                        }
                    },
                });

                $('#toutesDoléances tbody').on('click', 'td.details-control button', function () {
                    var tr = $(this).closest('tr');
                    var row = doleanceTable.row(tr);

                    if (row.child.isShown()) {
                        row.child.hide();
                        $(this).text('+');
                    } else {
                        row.child(formatInterventions(row.data())).show();
                        $(this).text('-');
                    }
                });
            }

            function formatInterventions(d) {
                if (!d.interventions || d.interventions.length === 0) {
                    return '<p>Aucune intervention pour cette doléance.</p>';
                }

                let html = '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">';
                html += '<tr><th>Date début</th><th>Date fin</th><th>Statut</th><th>Techniciens</th></tr>';

                d.interventions.forEach(function (intervention) {
                    html += '<tr>';
                    html += '<td>' + (intervention.top_debut || '') + '</td>';
                    html += '<td>' + (intervention.top_terminer || '') + '</td>';
                    html += '<td>' + intervention.statut + '</td>';
                    html += '<td>' + intervention.techniciens + '</td>';
                    html += '</tr>';
                });

                html += '</table>';
                return html;
            }

            function updateTable() {
                let year = $('#yearSelect').val();
                let month = $('#monthSelect').val();
                let startDate = $('#startDate').val();
                let endDate = $('#endDate').val();
                initializeTable(year, month, startDate, endDate);
            }

            $('#yearSelect, #monthSelect').on('change', updateTable);

            $('#showAllYear').on('click', function () {
                let year = $('#yearSelect').val();
                initializeTable(year, 'all', null, null);
            });

            $('#exportDateRange').on('click', function () {
                let startDate = $('#startDate').val();
                let endDate = $('#endDate').val();
                if (startDate && endDate) {
                    // Logique d'export à implémenter
                    initializeTable(null, null, startDate, endDate)
                } else {
                    alert('Veuillez sélectionner une plage de dates valide');
                }
            });

            updateTable();  // Initialiser la table au chargement de la page

            $('#toutesDoléances').on('click', '.declencher-intervention', function () {
                const doleanceId = $(this).data('id');
                declencherIntervention(doleanceId);
            });

            function declencherIntervention(doleanceId) {
                // Implémentez la logique pour déclencher une intervention ici
                alert('Déclencher intervention pour la doléance ' + doleanceId);
            }
        });
        $('#showAllYear').on('click', function () {
            let year = $('#yearSelect').val();
            initializeTable(year, 'all');
        });
    </script>
{% endblock extra_js %}