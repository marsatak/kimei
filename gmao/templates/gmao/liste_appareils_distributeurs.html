{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des Appareils Distributeurs{% endblock %}

{% block extra_css %}
<style>
    .card {
        height: 100%;
    }
    .pistolet-info {
        font-size: 0.9em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Liste des Appareils Distributeurs</h2>

    {% if user.role == 'ADMIN' %}
    <button id="ajouterDistributeur" class="btn btn-primary mb-3">Ajouter un distributeur</button>
    {% endif %}

    <div class="row">
        {% for appareil in appareils %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">{{ appareil.piste }}</h5>
                </div>
                <div class="card-body">
                    <p><strong>Modèle:</strong> {{ appareil.modele_ad }}</p>
                    <p><strong>Numéro de série:</strong> {{ appareil.num_serie }}</p>
                    <p><strong>Type de contrat:</strong> {{ appareil.type_contrat }}</p>
                    <p><strong>Pistolets:</strong></p>
                    <ul class="list-unstyled">
                        {% for pistolet in appareil.pistolets %}
                        <li class="pistolet-info">{{ pistolet|safe }}</li>
                        {% endfor %}
                    </ul>
                    {% if user.role == 'ADMIN' %}
                    <div class="mt-3">
                        <button class="btn btn-warning btn-sm modifier-appareil" data-id="{{ appareil.id }}">Modifier</button>
                        <button class="btn btn-danger btn-sm supprimer-appareil" data-id="{{ appareil.id }}">Supprimer</button>
                    </div>
                    {% elif user.role == 'TECH' %}
                    <button class="btn btn-info btn-sm details-appareil" data-id="{{ appareil.id }}">Voir détails</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

{% if user.role == 'ADMIN' %}
<!-- Modal pour ajouter/modifier un distributeur -->
<div class="modal fade" id="distributeurModal" tabindex="-1" role="dialog" aria-labelledby="distributeurModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="distributeurModalLabel">Ajouter/Modifier un distributeur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="distributeurForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="station">Station</label>
                        <select class="form-control" id="station" required>
                            <!-- Options seront chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modele">Modèle</label>
                        <select class="form-control" id="modele" required>
                            <!-- Options seront chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numSerie">Numéro de série</label>
                        <input type="text" class="form-control" id="numSerie" required>
                    </div>
                    <div class="form-group">
                        <label for="typeContrat">Type de contrat</label>
                        <select class="form-control" id="typeContrat" required>
                            <option value="Sous Contrat">Sous Contrat</option>
                            <option value="Hors Contrat">Hors Contrat</option>
                        </select>
                    </div>
                    <div id="faces">
                        <div class="form-group">
                            <label for="facePrincipale">Numéro Face Principale</label>
                            <input type="number" class="form-control" id="facePrincipale" required>
                        </div>
                        <h6>Face Primaire (R)</h6>
                        <div id="facePrimaireContainer">
                            <!-- Champs pour les pistolets de la face primaire seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletPrimaire">Ajouter pistolet face primaire</button>

                        <div class="form-group mt-3">
                            <label for="faceSecondaire">Numéro Face Secondaire</label>
                            <input type="number" class="form-control" id="faceSecondaire" required>
                        </div>
                        <h6 class="mt-3">Face Secondaire (L)</h6>
                        <div id="faceSecondaireContainer">
                            <!-- Champs pour les pistolets de la face secondaire seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletSecondaire">Ajouter pistolet face secondaire</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="sauvegarderDistributeur">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if user.role == 'TECH' %}
<!-- Modal pour afficher les détails d'un appareil -->
<div class="modal fade" id="detailsAppareilModal" tabindex="-1" role="dialog" aria-labelledby="detailsAppareilModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsAppareilModalLabel">Détails de l'appareil distributeur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Les détails de l'appareil seront chargés ici dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    {% if user.role == 'ADMIN' %}
    // Chargement des stations et modèles
    $.get("{% url 'get_stations' %}", function(data) {
        $('#station').html(data.map(station => `<option value="${station.id}">${station.libelle_station}</option>`).join(''));
    });

    $.get("{% url 'get_modeles_ad' %}", function(data) {
        $('#modele').html(data.map(modele => `<option value="${modele.id}">${modele.libelle_modele}</option>`).join(''));
    });

    // Fonction pour ajouter un champ de pistolet
    function ajouterChampPistolet(containerId, orientation) {
        var newField = `
            <div class="form-row pistolet-row">
                <div class="col">
                    <select class="form-control produit" required>
                        <!-- Options seront chargées dynamiquement -->
                    </select>
                </div>
                <div class="col">
                    <input type="date" class="form-control date-flexible">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger btn-sm remove-pistolet">Supprimer</button>
                </div>
            </div>
        `;
        $(`#${containerId}`).append(newField);

        // Charger les produits pour le nouveau champ
        $.get("{% url 'get_produits' %}", function(data) {
            $(`#${containerId} .produit:last`).html(data.map(produit => `<option value="${produit.id}">${produit.nom_produit}</option>`).join(''));
        });
    }

    $('#ajouterPistoletPrimaire').click(() => ajouterChampPistolet('facePrimaireContainer', 'R'));
    $('#ajouterPistoletSecondaire').click(() => ajouterChampPistolet('faceSecondaireContainer', 'L'));

    $(document).on('click', '.remove-pistolet', function() {
        $(this).closest('.pistolet-row').remove();
    });

    // Gérer l'ajout d'un nouveau distributeur
    $('#ajouterDistributeur').click(function() {
        $('#distributeurForm')[0].reset();
        $('#distributeurModal').modal('show');
    });

    // Sauvegarder le distributeur
    $('#sauvegarderDistributeur').click(function() {
        var formData = {
            station: $('#station').val(),
            modele_ad: $('#modele').val(),
            num_serie: $('#numSerie').val(),
            type_contrat: $('#typeContrat').val(),
            face_principal: $('#facePrincipale').val(),
            face_secondaire: $('#faceSecondaire').val(),
            faces: {
                R: [],
                L: []
            }
        };

        $('#facePrimaireContainer .pistolet-row').each(function() {
            formData.faces.R.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        $('#faceSecondaireContainer .pistolet-row').each(function() {
            formData.faces.L.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        $.ajax({
            url: "{% url 'ajouter_distributeur' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    $('#distributeurModal').modal('hide');
                    location.reload();  // Recharger la page pour afficher le nouveau distributeur
                } else {
                    alert('Erreur : ' + response.message);
                }
            },
            error: function() {
                alert('Une erreur est survenue lors de la sauvegarde.');
            }
        });
    });

    // Gérer la modification d'un distributeur
    $('.modifier-appareil').click(function() {
        var id = $(this).data('id');
        $.get("{% url 'get_distributeur' 0 %}".replace('0', id), function(data) {
            $('#station').val(data.station);
            $('#modele').val(data.modele_ad);
            $('#numSerie').val(data.num_serie);
            $('#typeContrat').val(data.type_contrat);
            $('#facePrincipale').val(data.face_principal);
            $('#faceSecondaire').val(data.face_secondaire);

            $('#facePrimaireContainer').empty();
            $('#faceSecondaireContainer').empty();

            data.pistolets.forEach(function(pistolet) {
                var containerId = pistolet.orientation === 'R' ? 'facePrimaireContainer' : 'faceSecondaireContainer';
                ajouterChampPistolet(containerId, pistolet.orientation);
                $(`#${containerId} .pistolet-row:last .produit`).val(pistolet.produit);
                $(`#${containerId} .pistolet-row:last .date-flexible`).val(pistolet.date_flexible);
            });

            $('#distributeurModal').modal('show');
        });
    });

    // Gérer la suppression d'un distributeur
    $('.supprimer-appareil').click(function() {
        var id = $(this).data('id');
        if (confirm('Êtes-vous sûr de vouloir supprimer ce distributeur ?')) {
            $.ajax({
                url: "{% url 'supprimer_distributeur' 0 %}".replace('0', id),
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response) {
                    if (response.success) {
                        location.reload();  // Recharger la page pour refléter la suppression
                    } else {
                        alert('Erreur : ' + response.message);
                    }
                },
                error: function() {
                    alert('Une erreur est survenue lors de la suppression.');
                }
            });
        }
    });
    {% endif %}

    {% if user.role == 'TECH' %}
    // Afficher les détails d'un appareil pour les techniciens
    $('.details-appareil').click(function() {
        var id = $(this).data('id');
        $.get("{% url 'get_distributeur' 0 %}".replace('0', id), function(data) {
            var detailsHtml = `
                <p><strong>Station:</strong> ${data.piste}</p>
                <p><strong>Modèle:</strong> ${data.modele_ad}</p>
                <p><strong>Numéro de série:</strong> ${data.num_serie}</p>
                <p><strong>Type de contrat:</strong> ${data.type_contrat}</p>
                <p><strong>Face Principale:</strong> ${data.face_principal}</p>
                <p><strong>Face Secondaire:</strong> ${data.face_secondaire}</p>
                <p><strong>Pistolets:</strong></p>
                <ul>
                    ${data.pistolets.map(p => `<li>${p.orientation}${p.id} - ${p.produit} (${p.date_flexible || 'ILLI'})</li>`).join('')}
                </ul>
            `;
            $('#detailsAppareilModal .modal-body').html(detailsHtml);
            $('#detailsAppareilModal').modal('show');
        });
    });
    {% endif %}
});
</script>
{% endblock %}