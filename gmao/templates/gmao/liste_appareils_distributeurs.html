{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des Appareils Distributeurs{% endblock %}

{% block content %}
    <div class="container-fluid mt-4">
        <h2 class="mb-4">Liste des Appareils Distributeurs</h2>

        {% if user.role == 'ADMIN' %}
            <button id="ajouterDistributeur" class="btn btn-primary mb-3">Ajouter un distributeur</button>
        {% endif %}

        <div class="row" id="appareilsContainer">
            <!-- Les appareils seront chargés ici dynamiquement -->
        </div>
    </div>

    <div id="distributeurModal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="distributeurModalLabel">Ajouter/Modifier un distributeur</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="distributeurForm">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="station">Station</label>
                            <select class="form-control" id="station" required></select>
                        </div>
                        <div class="form-group">
                            <label for="modele">Modèle</label>
                            <select class="form-control" id="modele" required></select>
                        </div>
                        <div class="form-group">
                            <label for="numSerie">Numéro de série</label>
                            <input type="text" class="form-control" id="numSerie" required>
                        </div>
                        <div class="form-group">
                            <label for="typeContrat">Type de contrat</label>
                            <select class="form-control" id="typeContrat" required>
                                <option value="Sous Contrat">Sous Contrat</option>
                                <option value="Hors Contrat">Hors Contrat</option>
                            </select>
                        </div>
                        <div id="faces">
                            <div class="form-group">
                                <label for="facePrincipale">Numéro Face Principale</label>
                                <input type="number" class="form-control" id="facePrincipale" required>
                            </div>
                            <h6>Face Primaire (R)</h6>
                            <div id="facePrimaireContainer"></div>
                            <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletPrimaire">Ajouter
                                pistolet face primaire
                            </button>

                            <div class="form-group mt-3">
                                <label for="faceSecondaire">Numéro Face Secondaire</label>
                                <input type="number" class="form-control" id="faceSecondaire" required>
                            </div>
                            <h6 class="mt-3">Face Secondaire (L)</h6>
                            <div id="faceSecondaireContainer"></div>
                            <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletSecondaire">Ajouter
                                pistolet face secondaire
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="sauvegarderDistributeur">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block extra_css %}
    <style>
        .card {
            height: 100%;
        }

        .pistolet-info {
            font-size: 0.9em;
        }
    </style>
{% endblock %}
{% block extra_js %}
<script>
$(document).ready(function() {
    function loadAppareils() {
        $.ajax({
            url: "{% url 'gmao:get_appareils_distributeurs_data' %}",
            type: 'GET',
            success: function(response) {
                var appareilsHtml = '';
                response.data.forEach(function(appareil) {
                    appareilsHtml += `
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="card-title mb-0">${appareil.piste}</h5>
                                </div>
                                <div class="card-body">
                                    <p><strong>Modèle:</strong> ${appareil.modele_ad}</p>
                                    <p><strong>Numéro de série:</strong> ${appareil.num_serie}</p>
                                    <p><strong>Type de contrat:</strong> ${appareil.type_contrat}</p>
                                    <p><strong>Pistolets:</strong></p>
                                    <ul class="list-unstyled">
                                        ${appareil.pistolets.split('<br>').map(p => `<li class="pistolet-info">${p}</li>`).join('')}
                                    </ul>
                                    <button class="btn btn-warning btn-sm modifier-appareil" data-id="${appareil.id}">Modifier</button>
                                    {% if user.role == 'ADMIN' %}
                                    <button class="btn btn-danger btn-sm supprimer-appareil" data-id="${appareil.id}">Supprimer</button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    `;
                });
                $('#appareilsContainer').html(appareilsHtml);
            },
            error: function(xhr, status, error) {
                console.error("Erreur lors du chargement des appareils:", error);
                $('#appareilsContainer').html('<p class="text-danger">Erreur lors du chargement des appareils.</p>');
            }
        });
    }

    loadAppareils();

    function ajouterChampPistolet(containerId, orientation) {
        const newField = `
            <div class="form-row pistolet-row">
                <div class="col">
                    <select class="form-control produit" required></select>
                </div>
                <div class="col">
                    <input type="date" class="form-control date-flexible">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger btn-sm remove-pistolet">Supprimer</button>
                </div>
            </div>
        `;
        $(`#${containerId}`).append(newField);

        $.get("{% url 'gmao:get_produits' %}", function(data) {
            $(`#${containerId} .produit:last`).html(data.map(produit => `<option value="${produit.id}">${produit.nom_produit}</option>`).join(''));
        });
    }

    $('#ajouterPistoletPrimaire').click(() => ajouterChampPistolet('facePrimaireContainer', 'R'));
    $('#ajouterPistoletSecondaire').click(() => ajouterChampPistolet('faceSecondaireContainer', 'L'));

    $(document).on('click', '.remove-pistolet', function() {
        $(this).closest('.pistolet-row').remove();
    });

    $('#sauvegarderDistributeur').click(function() {
        var formData = {
            station: $('#station').val(),
            modele_ad: $('#modele').val(),
            num_serie: $('#numSerie').val(),
            type_contrat: $('#typeContrat').val(),
            face_principal: $('#facePrincipale').val(),
            face_secondaire: $('#faceSecondaire').val(),
            faces: {
                R: [],
                L: []
            }
        };

        $('#facePrimaireContainer .pistolet-row').each(function(index) {
            formData.faces.R.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        $('#faceSecondaireContainer .pistolet-row').each(function(index) {
            formData.faces.L.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        var url = $('#distributeurForm').data('id')
            ? "{% url 'gmao:update_distributeur' 0 %}".replace('0', $('#distributeurForm').data('id'))
            : "{% url 'gmao:ajouter_distributeur' %}";

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    $('#distributeurModal').modal('hide');
                    loadAppareils();
                } else {
                    alert('Erreur : ' + response.message);
                }
            },
            error: function() {
                alert('Une erreur est survenue lors de la sauvegarde.');
            }
        });
    });

    $(document).on('click', '.modifier-appareil', function() {
        var id = $(this).data('id');
        $.get("{% url 'gmao:get_distributeur' 0 %}".replace('0', id), function(data) {
            $('#distributeurForm').data('id', id);
            $('#station').val(data.station);
            $('#modele').val(data.modele_ad);
            $('#numSerie').val(data.num_serie);
            $('#typeContrat').val(data.type_contrat);
            $('#facePrincipale').val(data.face_principal);
            $('#faceSecondaire').val(data.face_secondaire);

            $('#facePrimaireContainer').empty();
            $('#faceSecondaireContainer').empty();

            data.pistolets.forEach(function(pistolet) {
                const containerId = pistolet.orientation === 'R' ? 'facePrimaireContainer' : 'faceSecondaireContainer';
                ajouterChampPistolet(containerId, pistolet.orientation);
                $(`#${containerId} .pistolet-row:last .produit`).val(pistolet.produit);
                $(`#${containerId} .pistolet-row:last .date-flexible`).val(pistolet.date_flexible);
            });

            $('#distributeurModal').modal('show');
        });
    });

    {% if user.role == 'ADMIN' %}
    $('#ajouterDistributeur').click(function() {
        $('#distributeurForm')[0].reset();
        $('#distributeurForm').removeData('id');
        $('#facePrimaireContainer').empty();
        $('#faceSecondaireContainer').empty();
        $('#distributeurModal').modal('show');
    });

    $(document).on('click', '.supprimer-appareil', function() {
        var id = $(this).data('id');
        if (confirm('Êtes-vous sûr de vouloir supprimer ce distributeur ?')) {
            $.ajax({
                url: "{% url 'gmao:supprimer_distributeur' 0 %}".replace('0', id),
                type: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'},
                success: function(response) {
                    if (response.success) {
                        loadAppareils();
                    } else {
                        alert('Erreur : ' + response.message);
                    }
                },
                error: function() {
                    alert('Une erreur est survenue lors de la suppression.');
                }
            });
        }
    });
    {% endif %}

    $.get("{% url 'gmao:get_stations' %}", function(data) {
        $('#station').html(data.map(station => `<option value="${station.id}">${station.libelle_station}</option>`).join(''));
    });

    $.get("{% url 'gmao:get_modeles_ad' %}", function(data) {
        $('#modele').html(data.map(modele => `<option value="${modele.id}">${modele.libelle_modele}</option>`).join(''));
    });
});
</script>
{% endblock %}