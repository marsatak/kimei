{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des Appareils Distributeurs{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Liste des Appareils Distributeurs</h2>

    {% if user.role == 'ADMIN' %}
    <button id="ajouterDistributeur" class="btn btn-primary mb-3">Ajouter un distributeur</button>
    {% endif %}

    <div class="table-responsive">
        <table id="tableDistributeurs" class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Station - AD</th>
                    <th>Modèle</th>
                    <th>Numéro de série</th>
                    <th>Type de contrat</th>
                    <th>Pistolets</th>
                    {% if user.role == 'ADMIN' %}
                    <th>Actions</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                <!-- Les données seront chargées ici dynamiquement -->
            </tbody>
        </table>
    </div>
</div>

{% if user.role == 'ADMIN' %}
<div id="distributeurModal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="distributeurModalLabel">Ajouter/Modifier un distributeur</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="distributeurForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="station">Station</label>
                        <select class="form-control" id="station" required>
                            <!-- Options seront chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modele">Modèle</label>
                        <select class="form-control" id="modele" required>
                            <!-- Options seront chargées dynamiquement -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="numSerie">Numéro de série</label>
                        <input type="text" class="form-control" id="numSerie" required>
                    </div>
                    <div class="form-group">
                        <label for="typeContrat">Type de contrat</label>
                        <select class="form-control" id="typeContrat" required>
                            <option value="Sous Contrat">Sous Contrat</option>
                            <option value="Hors Contrat">Hors Contrat</option>
                        </select>
                    </div>
                    <div id="faces">
                        <div class="form-group">
                            <label for="facePrincipale">Numéro Face Principale</label>
                            <input type="number" class="form-control" id="facePrincipale" required>
                        </div>
                        <h6>Face Primaire (R)</h6>
                        <div id="facePrimaireContainer">
                            <!-- Champs pour les pistolets de la face primaire seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletPrimaire">Ajouter pistolet face primaire</button>

                        <div class="form-group mt-3">
                            <label for="faceSecondaire">Numéro Face Secondaire</label>
                            <input type="number" class="form-control" id="faceSecondaire" required>
                        </div>
                        <h6 class="mt-3">Face Secondaire (L)</h6>
                        <div id="faceSecondaireContainer">
                            <!-- Champs pour les pistolets de la face secondaire seront ajoutés ici -->
                        </div>
                        <button type="button" class="btn btn-secondary mt-2" id="ajouterPistoletSecondaire">Ajouter pistolet face secondaire</button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="sauvegarderDistributeur">Enregistrer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const table = $('#tableDistributeurs').DataTable({
        ajax: {
            url: "{% url 'gmao:get_appareils_distributeurs_data' %}",
            dataSrc: 'data'
        },
        columns: [
            { data: 'id' },
            { data: 'piste' },
            { data: 'modele_ad' },
            { data: 'num_serie' },
            { data: 'type_contrat' },
            { data: 'pistolets' },
            {% if user.role == 'ADMIN' %}
            {
                data: null,
                render: function(data, type, row) {
                    return '<button class="btn btn-sm btn-warning edit-distributeur" data-id="' + row.id + '">Modifier</button> ' +
                           '<button class="btn btn-sm btn-danger delete-distributeur" data-id="' + row.id + '">Supprimer</button>';
                }
            }
            {% endif %}
        ]
    });

    {% if user.role == 'ADMIN' %}
    // Chargement des stations et modèles pour le formulaire
    $.get("{% url 'gmao:get_stations' %}", function(data) {
        $('#station').html(data.map(station => `<option value="${station.id}">${station.libelle_station}</option>`).join(''));
    });

    $.get("{% url 'gmao:get_modeles_ad' %}", function(data) {
        $('#modele').html(data.map(modele => `<option value="${modele.id}">${modele.libelle_modele}</option>`).join(''));
    });

    // Fonction pour ajouter un champ de pistolet
    function ajouterChampPistolet(containerId, orientation) {
        const newField = `
            <div class="form-row pistolet-row">
                <div class="col">
                    <select class="form-control produit" required>
                        <!-- Options seront chargées dynamiquement -->
                    </select>
                </div>
                <div class="col">
                    <input type="date" class="form-control date-flexible">
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-danger btn-sm remove-pistolet">Supprimer</button>
                </div>
            </div>
        `;
        $(`#${containerId}`).append(newField);

        // Charger les produits pour le nouveau champ
        $.get("{% url 'gmao:get_produits' %}", function(data) {
            $(`#${containerId} .produit:last`).html(data.map(produit => `<option value="${produit.id}">${produit.nom_produit}</option>`).join(''));
        });
    }

    $('#ajouterPistoletPrimaire').click(() => ajouterChampPistolet('facePrimaireContainer', 'R'));
    $('#ajouterPistoletSecondaire').click(() => ajouterChampPistolet('faceSecondaireContainer', 'L'));

    $(document).on('click', '.remove-pistolet', function() {
        $(this).closest('.pistolet-row').remove();
    });

    // Gérer l'ajout d'un nouveau distributeur
    $('#ajouterDistributeur').click(function() {
        $('#distributeurForm')[0].reset();
        $('#distributeurModal').modal('show');
    });

    // Sauvegarder le distributeur
    $('#sauvegarderDistributeur').click(function() {
        const formData = {
            station: $('#station').val(),
            modele_ad: $('#modele').val(),
            num_serie: $('#numSerie').val(),
            type_contrat: $('#typeContrat').val(),
            face_principal: $('#facePrincipale').val(),
            face_secondaire: $('#faceSecondaire').val(),
            faces: {
                R: [],
                L: []
            }
        };

        $('#facePrimaireContainer .pistolet-row').each(function() {
            formData.faces.R.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        $('#faceSecondaireContainer .pistolet-row').each(function() {
            formData.faces.L.push({
                produit: $(this).find('.produit').val(),
                date_flexible: $(this).find('.date-flexible').val()
            });
        });

        $.ajax({
            url: "{% url 'gmao:ajouter_distributeur' %}",
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                if (response.success) {
                    $('#distributeurModal').modal('hide');
                    table.ajax.reload();
                } else {
                    alert('Erreur : ' + response.message);
                }
            },
            error: function() {
                alert('Une erreur est survenue lors de la sauvegarde.');
            }
        });
    });

    // Gérer la modification d'un distributeur
    $('#tableDistributeurs').on('click', '.edit-distributeur', function() {
        const id = $(this).data('id');
        $.get("{% url 'gmao:get_distributeur' 0 %}".replace('0', id), function(data) {
            $('#station').val(data.station);
            $('#modele').val(data.modele_ad);
            $('#numSerie').val(data.num_serie);
            $('#typeContrat').val(data.type_contrat);
            $('#facePrincipale').val(data.face_principal);
            $('#faceSecondaire').val(data.face_secondaire);

            $('#facePrimaireContainer').empty();
            $('#faceSecondaireContainer').empty();

            data.pistolets.forEach(function(pistolet) {
                const containerId = pistolet.orientation === 'R' ? 'facePrimaireContainer' : 'faceSecondaireContainer';
                ajouterChampPistolet(containerId, pistolet.orientation);
                $(`#${containerId} .pistolet-row:last .produit`).val(pistolet.produit);
                $(`#${containerId} .pistolet-row:last .date-flexible`).val(pistolet.date_flexible);
            });

            $('#distributeurModal').modal('show');
        });
    });

    // Gérer la suppression d'un distributeur
    $('#tableDistributeurs').on('click', '.delete-distributeur', function() {
        const id = $(this).data('id');
        if (confirm('Êtes-vous sûr de vouloir supprimer ce distributeur ?')) {
            $.ajax({
                url: "{% url 'gmao:supprimer_distributeur' 0 %}".replace('0', id),
                type: 'POST',
                success: function(response) {
                    if (response.success) {
                        table.ajax.reload();
                    } else {
                        alert('Erreur : ' + response.message);
                    }
                },
                error: function() {
                    alert('Une erreur est survenue lors de la suppression.');
                }
            });
        }
    });
    {% endif %}
});
</script>
{% endblock %}