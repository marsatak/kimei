{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des interventions{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
{% endblock extra_css %}

{% block content %}
    <div class="container-fluid mt-3">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Liste des interventions du {{ current_date|date:"d/m/Y" }}</h4>
                    </div>
                    <div class="card-body">
                        {% if user_role == 'ADMIN' %}
                            <div class="filter-container mb-3">
                                <input type="text" id="startDate" class="form-control form-control-sm flatpickr-input"
                                       placeholder="Date début">
                                <input type="text" id="endDate" class="form-control form-control-sm flatpickr-input"
                                       placeholder="Date fin">
                                <button id="filterDate" class="btn btn-info btn-sm">Filtrer</button>
                                <button id="resetDate" class="btn btn-secondary btn-sm">Réinitialiser</button>
                            </div>
                        {% endif %}
                        <table id="interventionsTable" class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <th>NDI</th>
                                <th>Station</th>
                                <th>Panne</th>
                                <th>Prise en charge</th>
                                <th>Début travail</th>
                                <th>Fin travail</th>
                                <th>Statut</th>
                                <th>Techniciens</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
    <script src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script>
        $(document).ready(function () {
            {% if user_role == 'ADMIN' %}
                flatpickr("#startDate", {
                    dateFormat: "Y-m-d",
                });
                flatpickr("#endDate", {
                    dateFormat: "Y-m-d",
                });
            {% endif %}

            var table = $('#interventionsTable').DataTable({
                ajax: {
                    url: '{% url "gmao:get_interventions_data" %}',
                    data: function (d) {
                        {% if user_role == 'ADMIN' %}
                            d.startDate = $('#startDate').val();
                            d.endDate = $('#endDate').val();
                        {% endif %}
                    }
                },
                columns: [
                    {data: 'ndi'},
                    {data: 'station'},
                    {data: 'panne'},
                    {data: 'prise_en_charge'},
                    {data: 'debut_travail'},
                    {data: 'fin_travail'},
                    {data: 'statut'},
                    {data: 'techniciens'},
                    {
                        data: null,
                        render: function (data, type, row) {
                            return '<a href="/home/intervention/' + row.id + '/" class="btn btn-sm btn-primary">Éditer</a>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/French.json'
                }
            });

            {% if user_role == 'ADMIN' %}
                $('#filterDate').on('click', function () {
                    table.ajax.reload();
                });

                $('#resetDate').on('click', function () {
                    $('#startDate').val('');
                    $('#endDate').val('');
                    table.ajax.reload();
                });
            {% endif %}
        });
    </script>
{% endblock extra_js %}